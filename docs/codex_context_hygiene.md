# Codex Context Hygiene для Krab

## Что это и зачем
Этот документ фиксирует практики работы с Codex-тредами, чтобы избежать ошибки `413 Payload Too Large` при автоматическом compact-контекста и не терять рабочий прогресс по дебагу/разработке Краба.

Связь с проектом:
- Используется при отладке веток Krab с большими логами, скриншотами и diff.
- Дополняет `HANDOVER.md` как операционный runbook именно для IDE/чата Codex.

## Почему возникает 413
`413 Payload Too Large` в Codex обычно означает, что накопился слишком большой контекст треда (много скриншотов, длинные логи, крупные diff), и endpoint compact не смог обработать объём.

Это инфраструктурная ошибка контекста треда, а не баг кода Краба.

## Практики профилактики
1. Не копить много скриншотов в одном треде.
2. Не вставлять полные логи; отправлять только целевые фрагменты 20-40 строк вокруг маркера ошибки.
3. После крупных этапов (большой diff, серия фиксов, длинный дебаг) делать checkpoint и переходить в новый тред.
4. В конце каждого этапа писать короткий summary:
   - цель шага,
   - что изменено,
   - что проверено,
   - что осталось.
5. Для длинных артефактов использовать ссылки на файлы в репозитории вместо вставки целиком в чат.
6. Для повторяемых проверок использовать `.command`-скрипты, чтобы в чат попадал итог, а не сырые длинные трассы.
7. Перед закрытием треда запускать:
   - `/Users/pablito/Antigravity_AGENTS/Краб/new_chat_checkpoint.command`
   - и переносить блок `[CHECKPOINT]` в новый чат.

## Рекомендуемый формат отчёта в чат
1. Симптом (1-2 строки).
2. Логи (20-40 строк, только вокруг маркера).
3. Текущее состояние (`!status` / ключевые counters).
4. Последний commit/hash или список изменённых файлов.
5. Ожидаемое поведение.

## Когда открывать новый тред сразу
1. Когда отправлено более 8-10 скриншотов подряд.
2. Когда в чат уже вставлялись очень длинные логи (несколько экранов).
3. Когда обсуждение объединяет несколько независимых задач (дебаг + фичи + рефакторинг).
4. Когда Codex уже один раз показал ошибку compact/413 в этом треде.
5. Когда в одном треде уже прошло 45-60 минут активной разработки с большими diff.
6. Когда изменено >15 файлов и нужно переключиться на другую подсистему.

## Операционный порог переключения (рекомендация)

Используй правило `3 из 6`:
1. >45 минут непрерывной работы в одном треде;
2. >15 изменённых файлов;
3. >8 скриншотов в треде;
4. >2 больших блока логов;
5. >2 независимых подзадач в одном обсуждении;
6. уже была одна ошибка compact/413.

Если выполняются 3 и более пункта — лучше сразу открывать новый чат.

## Как держать параллельные чаты/приложения без конфликтов

1. Одна ветка Git = один поток работы.
2. Разные потоки держать в отдельных worktree/копиях, а не в одной рабочей папке.
3. Перед merge запускать overlap-гейт:
   - `scripts/check_workstream_overlap.command`
   - `scripts/merge_guard.command`
4. Для каждого потока фиксировать checkpoint-файл:
   - `artifacts/context_checkpoints/checkpoint_*.md`.
5. Не смешивать в одном треде одновременно:
   - продуктовые фичи;
   - инфраструктуру OpenClaw;
   - аварийный дебаг.

## Рекомендованный workflow по нескольким чатам

1. Поток A (Core Krab): отдельная ветка `codex/core-*`.
2. Поток B (OpenClaw Ops): отдельная ветка `codex/openclaw-*`.
3. Поток C (Ear/Voice integration): отдельная ветка `codex/interop-*`.
4. Перед паузой в каждом потоке:
   - `new_chat_checkpoint.command`;
   - короткий commit или как минимум `git status --short` в checkpoint.
5. Перед объединением:
   - `pytest -q` по затронутому проекту;
   - затем `merge_guard`.

## Мини-чеклист перед отправкой сообщения
- Это минимально нужный контекст?
- Можно ли сократить лог до 20-40 строк?
- Есть ли summary вместо повторного пересказа всей истории?
- Не лучше ли создать новый тред с ссылкой на checkpoint?
- Есть ли актуальный файл `checkpoint_*.md` на случай обрыва?
