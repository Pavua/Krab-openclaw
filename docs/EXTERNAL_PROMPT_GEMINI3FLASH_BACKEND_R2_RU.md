# EXTERNAL PROMPT — GEMINI 3.1 FLASH (BACKEND R2)

Работаем в потоке `backend`.
Модель: **Gemini 3.1 Flash**.

## Контекст
В `src/handlers/tools.py` добавлено много повторяющихся блоков ошибок для Voice Gateway (один и тот же шаблон ответа дублируется десятки раз).
Это снижает поддерживаемость и повышает риск рассинхрона текста/форматирования.

## Цель R2
Сделать безопасный рефакторинг без изменения функционального поведения:
- вынести форматирование ошибок Voice Gateway в единый helper;
- использовать helper во всех релевантных обработчиках;
- добавить тесты на форматирование/экранирование динамического текста ошибки.

## Жесткие ограничения
1. Не менять бизнес-логику команд, только устранить дублирование и риск форматирования.
2. Не трогать frontend.
3. Не трогать OpenClaw gateway/роутинг моделей.

## Что сделать
1. В `src/handlers/tools.py`:
- добавить приватный helper для однотипного error-message ответа Voice Gateway;
- заменить повторяющиеся блоки на вызов helper.
2. Добавить тесты:
- новый файл `tests/test_tools_voice_gateway_errors.py`;
- покрыть минимум: базовая ошибка, пустая ошибка, ошибка со спецсимволами (backticks/markdown-символы).
3. Проверить, что существующие тесты не ломаются.

## Разрешенные файлы для изменений
- `src/handlers/tools.py`
- `tests/test_tools_voice_gateway_errors.py` (новый)
- при необходимости `tests/test_voice_gateway_hardening.py`

## Обязательная самопроверка
Запустить:
- `pytest -q tests/test_tools_voice_gateway_errors.py tests/test_voice_gateway_hardening.py`

## Формат сдачи
В конце выдай:
1. Список изменённых файлов.
2. Точные команды тестов.
3. Итог тестов (PASS/FAIL).
4. Короткое описание что именно рефакторили.
