# ROADMAP_KRAB_EAR.md

Обновлено: 2026-02-16  
Статус: Draft (готово к передаче в Antigravity)

## Цель сервиса
`Krab Ear` — независимый сервис распознавания речи и аудио-предобработки.
Сервис не содержит бизнес-логики Telegram и не зависит от `Krab` рантайма напрямую.

## Почему раздельно
- Упрощается масштабирование STT отдельно от чата.
- Падение STT-контура не валит `Krab Core`.
- Можно переиспользовать `Krab Ear` в других каналах (не только Telegram).

## Контракт интеграции (минимум)
### REST
- `POST /v1/stt/transcribe`
  - вход: `audio_url|audio_file`, `lang_hint`, `chat_id`, `message_id`, `trace_id`
  - выход: `text`, `confidence`, `duration_ms`, `engine`, `segments[]`
- `GET /health`
- `GET /metrics`

### События (опционально)
- `stt.completed`
- `stt.failed`

## Фазы
### EAR-1 (P0): Надёжность STT
- [ ] Унифицированный pipeline загрузки аудио (voice/audio/ogg/mp3/m4a).
- [ ] Нормализация громкости/шумоподавление.
- [ ] Таймауты и retry-политика.
- [ ] Идемпотентность по `(chat_id,message_id)`.

### EAR-2 (P0): Качество и наблюдаемость
- [ ] WER-бенчмарк на тестовом наборе.
- [ ] Логи: latency, confidence, failure reason.
- [ ] Метрики p50/p95/p99 и error rate.

### EAR-3 (P1): Контекстная транскрибация
- [ ] Поддержка domain hints (финансы, код, разговорный).
- [ ] User dictionary (имена/термины владельца).
- [ ] Пост-обработка пунктуации и нормализации.

### EAR-4 (P1): Offline/Remote режим
- [ ] Режим «локально на Mac» и «через API-шлюз».
- [ ] Ограничение по размеру/длительности аудио.
- [ ] Безопасное хранение временных файлов и автоочистка.

## KPI
- STT success rate >= 98% на валидных аудио.
- P95 latency <= 8s для voice <= 60s.
- Дубли обработки одного сообщения = 0.

## Definition of Done
- Есть независимый smoke-тест `Krab Ear`.
- Есть контрактные тесты совместимости с `Krab`.
- Есть отдельный релизный чеклист.
