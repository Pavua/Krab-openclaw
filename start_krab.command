#!/bin/zsh
# ==============================================================
# ü¶Ä Krab v2.0 ‚Äî –ó–∞–ø—É—Å–∫ "–≤ –æ–¥–∏–Ω –∫–ª–∏–∫"
# –î–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏ –ø–æ —ç—Ç–æ–º—É —Ñ–∞–π–ª—É –≤ Finder –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.
# ==============================================================

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")"

echo "ü¶Ä =============================="
echo "   Krab v2.0 ‚Äî Starting Up..."
echo "   =============================="

# –£–±–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –µ—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
if pgrep -f "python3 -m src.main" > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –£–±–∏–≤–∞—é –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å..."
    pkill -f "python3 -m src.main"
    sleep 2
fi

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ª–æ–≥–æ–≤
mkdir -p logs artifacts/downloads

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º venv
source .venv/bin/activate

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install --quiet --upgrade pyrogram google-generativeai python-dotenv aiohttp Pillow psutil 2>/dev/null

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞..."
nohup python3 -m src.main > logs/krab.log 2>&1 &
BOT_PID=$!
echo $BOT_PID > krab.pid

# –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º
if ps -p $BOT_PID > /dev/null 2>&1; then
    echo ""
    echo "‚úÖ Krab v2.0 –∑–∞–ø—É—â–µ–Ω! (PID: $BOT_PID)"
    echo ""
    echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "   !help      ‚Äî –°–ø—Ä–∞–≤–∫–∞"
    echo "   !status    ‚Äî –°—Ç–∞—Ç—É—Å AI"
    echo "   !diagnose  ‚Äî –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"
    echo "   !summary   ‚Äî –°–∞–º–º–∞—Ä–∏ —á–∞—Ç–∞"
    echo "   !translate  ‚Äî –ü–µ—Ä–µ–≤–æ–¥"
    echo "   !say       ‚Äî –ì–æ–ª–æ—Å–æ–≤–æ–µ"
    echo "   !code      ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞"
    echo "   !exec      ‚Äî Python REPL (Owner)"
    echo ""
    echo "üìÑ –õ–æ–≥–∏: logs/krab.log"
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: kill $BOT_PID"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞! –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:"
    echo "   cat logs/krab.log"
fi

echo ""
echo "–ù–∞–∂–º–∏ Enter –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —ç—Ç–æ–≥–æ –æ–∫–Ω–∞..."
read
