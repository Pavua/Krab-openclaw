<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krab Web Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0c1016;
            --card-bg: rgba(255, 255, 255, 0.06);
            --accent: #1fb6ff;
            --text: #ecf2ff;
            --muted: #a7b5cc;
            --ok: #22c55e;
            --warn: #f59e0b;
            --bad: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at 10% 20%, #152336 0%, var(--bg) 42%);
            color: var(--text);
            padding: 24px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            letter-spacing: 0.03em;
        }

        .subtitle {
            margin: 0;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .row {
            display: grid;
            gap: 14px;
            margin-bottom: 14px;
        }

        .row.metrics {
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        }

        .row.wide {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .card {
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 16px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
        }

        .k {
            margin: 0 0 8px;
            color: var(--muted);
            font-size: 0.86rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .v {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 700;
            line-height: 1.2;
            word-break: break-word;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.82rem;
            border: 1px solid;
            margin-right: 8px;
        }

        .ok {
            color: var(--ok);
            border-color: var(--ok);
            background: rgba(34, 197, 94, 0.15);
        }

        .warn {
            color: var(--warn);
            border-color: var(--warn);
            background: rgba(245, 158, 11, 0.16);
        }

        .bad {
            color: var(--bad);
            border-color: var(--bad);
            background: rgba(239, 68, 68, 0.16);
        }

        .links a {
            display: block;
            color: #9ed5ff;
            text-decoration: none;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .links a:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .meta {
            color: var(--muted);
            font-size: 0.84rem;
        }

        .refresh {
            border: 1px solid rgba(255, 255, 255, 0.16);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            padding: 8px 12px;
            cursor: pointer;
        }

        .refresh:hover {
            border-color: var(--accent);
        }

        .field {
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.16);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            padding: 10px 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
        }

        .field::placeholder {
            color: var(--muted);
        }

        .row-inline {
            display: grid;
            grid-template-columns: 1fr 160px 150px;
            gap: 10px;
            margin-bottom: 10px;
        }

        .assistant-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .assistant-output {
            white-space: pre-wrap;
            line-height: 1.45;
            font-size: 0.95rem;
            min-height: 120px;
            max-height: 340px;
            overflow: auto;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            padding: 10px;
            background: rgba(8, 12, 18, 0.5);
        }

        .ops-list {
            margin: 0;
            padding-left: 18px;
            line-height: 1.4;
            color: var(--text);
        }

        .ops-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .ops-history {
            margin-top: 10px;
            max-height: 140px;
            overflow: auto;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            padding: 8px;
            background: rgba(8, 12, 18, 0.5);
            font-size: 0.84rem;
            line-height: 1.35;
            color: var(--muted);
        }

        @media (max-width: 700px) {
            body {
                padding: 14px;
            }

            .v {
                font-size: 1.3rem;
            }

            .row-inline {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>ü¶Ä Krab Web Panel</h1>
                <p class="subtitle">–ï–¥–∏–Ω—ã–π –æ–±–∑–æ—Ä —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã: Krab + OpenClaw + Voice Gateway + Local LM</p>
            </div>
            <button id="refreshBtn" class="refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </header>

        <div class="row metrics">
            <div class="card">
                <p class="k">–°–∏—Å—Ç–µ–º–∞</p>
                <p class="v" id="degradation">‚Äî</p>
            </div>
            <div class="card">
                <p class="k">Black Box</p>
                <p class="v" id="bb_total">‚Äî</p>
            </div>
            <div class="card">
                <p class="k">RAG Docs</p>
                <p class="v" id="rag_total">‚Äî</p>
            </div>
            <div class="card">
                <p class="k">Local Model</p>
                <p class="v" id="local_model">‚Äî</p>
            </div>
        </div>

        <div class="row wide">
            <div class="card">
                <p class="k">–°–µ—Ä–≤–∏—Å—ã</p>
                <div id="checks">‚Äî</div>
                <p class="meta" id="updated_at"></p>
            </div>
            <div class="card links">
                <p class="k">–°—Å—ã–ª–∫–∏</p>
                <div id="links">‚Äî</div>
            </div>
            <div class="card">
                <p class="k">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å</p>
                <p class="v" id="recommended_model">‚Äî</p>
                <p class="meta" id="recommended_meta"></p>
            </div>
            <div class="card">
                <p class="k">Ops Alerts</p>
                <div id="opsAlerts" class="meta">‚Äî</div>
                <p class="meta" id="opsUsageMeta"></p>
                <div class="ops-actions">
                    <input id="opsAlertCode" class="field" placeholder="alert code (–Ω–∞–ø—Ä–∏–º–µ—Ä cloud_share_high)">
                    <input id="opsAlertNote" class="field" placeholder="note (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                    <button id="opsAckBtn" class="refresh">Ack</button>
                    <button id="opsUnackBtn" class="refresh">Unack</button>
                </div>
                <p class="meta" id="opsActionMeta">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ alert-–∞–º–∏ —á–µ—Ä–µ–∑ Web API</p>
                <div id="opsHistory" class="ops-history">–ò—Å—Ç–æ—Ä–∏—è ops: ‚Äî</div>
            </div>
        </div>

        <div class="row">
            <div class="card">
                <p class="k">Web Assistant (–±–µ–∑ Telegram)</p>
                <div class="row-inline">
                    <input id="assistantTaskType" class="field" value="chat" placeholder="task_type: chat/reasoning/coding/...">
                    <input id="assistantUseRag" class="field" value="off" placeholder="RAG: on/off">
                    <input id="assistantApiKey" class="field" placeholder="WEB_API_KEY (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)">
                </div>
                <textarea id="assistantPrompt" class="field" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è –ö—Ä–∞–±–∞..."></textarea>
                <div class="assistant-actions">
                    <button id="assistantPlanBtn" class="refresh">Preflight</button>
                    <button id="assistantRunBtn" class="refresh">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
                    <span class="meta" id="assistantMeta">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—Ä–æ—Å–∞–º</span>
                </div>
                <div id="assistantOutput" class="assistant-output">‚Äî</div>
                <div class="row-inline" style="margin-top:10px;">
                    <input id="feedbackScore" class="field" value="5" placeholder="–û—Ü–µ–Ω–∫–∞ 1-5">
                    <input id="feedbackProfile" class="field" placeholder="profile (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                    <input id="feedbackNote" class="field" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                </div>
                <div class="assistant-actions">
                    <button id="feedbackSendBtn" class="refresh">–û—Ü–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                    <button id="feedbackStatsBtn" class="refresh">–ü–æ–∫–∞–∑–∞—Ç—å Feedback Stats</button>
                    <span class="meta" id="feedbackMeta">–û—Ü–µ–Ω–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø—Ä–æ–≥–æ–Ω—É —Ä–æ—É—Ç–µ—Ä–∞, –µ—Å–ª–∏ profile/model –Ω–µ —É–∫–∞–∑–∞–Ω—ã</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        function badge(ok, label) {
            const cls = ok ? 'ok' : 'warn';
            return `<span class="badge ${cls}">${ok ? 'ON' : 'OFF'} ${label}</span>`;
        }

        function setText(id, value) {
            const node = document.getElementById(id);
            if (node) node.textContent = value;
        }

        async function fetchJson(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        }

        function readWebApiKey() {
            return (document.getElementById('assistantApiKey').value || '').trim();
        }

        async function postJson(url, body, withKey = true, method = 'POST') {
            const headers = { 'Content-Type': 'application/json' };
            if (withKey) {
                const webApiKey = readWebApiKey();
                if (webApiKey) {
                    headers['X-Krab-Web-Key'] = webApiKey;
                }
            }
            const response = await fetch(url, {
                method,
                headers,
                body: method === 'DELETE' ? undefined : JSON.stringify(body || {})
            });
            const payload = await response.json();
            if (!response.ok) {
                throw new Error(payload?.detail || `HTTP ${response.status}`);
            }
            return payload;
        }

        async function opsAckAction(isAck) {
            const code = (document.getElementById('opsAlertCode').value || '').trim();
            const note = (document.getElementById('opsAlertNote').value || '').trim();
            if (!code) {
                setText('opsActionMeta', '–û—à–∏–±–∫–∞: —É–∫–∞–∂–∏ alert code');
                return;
            }
            setText('opsActionMeta', `${isAck ? 'Ack' : 'Unack'} –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...`);
            try {
                if (isAck) {
                    await postJson(`/api/ops/ack/${encodeURIComponent(code)}`, { actor: 'web_panel', note });
                    setText('opsActionMeta', `OK: alert ${code} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω`);
                } else {
                    await postJson(`/api/ops/ack/${encodeURIComponent(code)}`, {}, true, 'DELETE');
                    setText('opsActionMeta', `OK: alert ${code} —Å–Ω—è—Ç —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è`);
                }
                await updateStats();
            } catch (error) {
                setText('opsActionMeta', `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function assistantQuery() {
            const prompt = (document.getElementById('assistantPrompt').value || '').trim();
            const taskType = (document.getElementById('assistantTaskType').value || 'chat').trim();
            const ragRaw = (document.getElementById('assistantUseRag').value || 'off').trim().toLowerCase();
            const webApiKey = (document.getElementById('assistantApiKey').value || '').trim();

            if (!prompt) {
                setText('assistantMeta', '–û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π prompt');
                return;
            }

            const useRag = ['1', 'on', 'true', 'yes', 'y'].includes(ragRaw);
            const headers = { 'Content-Type': 'application/json' };
            if (webApiKey) {
                headers['X-Krab-Web-Key'] = webApiKey;
            }

            setText('assistantMeta', '–í—ã–ø–æ–ª–Ω—è—é –∑–∞–ø—Ä–æ—Å...');
            document.getElementById('assistantOutput').textContent = '‚è≥ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...';

            try {
                const response = await fetch('/api/assistant/query', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        prompt,
                        task_type: taskType || 'chat',
                        use_rag: useRag
                    })
                });
                const payload = await response.json();
                if (!response.ok) {
                    throw new Error(payload?.detail || `HTTP ${response.status}`);
                }

                document.getElementById('assistantOutput').textContent = payload.reply || '(–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)';
                setText('assistantMeta', `OK ‚Ä¢ –ø—Ä–æ—Ñ–∏–ª—å: ${payload.profile || '-'} ‚Ä¢ task: ${payload.task_type || '-'}`);
                const lastRoute = payload.last_route || {};
                if (lastRoute.profile) {
                    document.getElementById('feedbackProfile').value = String(lastRoute.profile);
                }
                if (lastRoute.model || lastRoute.channel) {
                    setText(
                        'feedbackMeta',
                        `–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–≥–æ–Ω: ${lastRoute.model || '-'} (${lastRoute.channel || '-'})`
                    );
                }
            } catch (error) {
                document.getElementById('assistantOutput').textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                setText('assistantMeta', '–ó–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π');
            }
        }

        async function assistantPreflight() {
            const prompt = (document.getElementById('assistantPrompt').value || '').trim();
            const taskType = (document.getElementById('assistantTaskType').value || 'chat').trim();
            const webApiKey = (document.getElementById('assistantApiKey').value || '').trim();
            if (!prompt) {
                setText('assistantMeta', '–û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π prompt');
                return;
            }

            const headers = { 'Content-Type': 'application/json' };
            if (webApiKey) {
                headers['X-Krab-Web-Key'] = webApiKey;
            }

            setText('assistantMeta', '–°–æ–±–∏—Ä–∞—é preflight-–ø–ª–∞–Ω...');
            document.getElementById('assistantOutput').textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞...';

            try {
                const response = await fetch('/api/model/preflight', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        prompt,
                        task_type: taskType || 'chat'
                    })
                });
                const payload = await response.json();
                if (!response.ok) {
                    throw new Error(payload?.detail || `HTTP ${response.status}`);
                }
                if (!payload?.ok) {
                    throw new Error(payload?.error || 'preflight_failed');
                }

                const plan = payload.preflight || {};
                const execution = plan.execution || {};
                const warnings = plan.warnings || [];
                const reasons = plan.reasons || [];
                const warningText = warnings.length ? warnings.map((item) => `- ${item}`).join('\n') : '- –Ω–µ—Ç';
                const reasonText = reasons.length ? reasons.map((item) => `- ${item}`).join('\n') : '- –Ω–µ—Ç';

                document.getElementById('assistantOutput').textContent =
`Preflight:
task_type=${plan.task_type || '-'}
profile=${plan.profile || '-'}
critical=${plan.critical ? 'yes' : 'no'}
channel=${execution.channel || '-'}
model=${execution.model || '-'}
can_run_now=${execution.can_run_now ? 'yes' : 'no'}
requires_confirm=${execution.requires_confirm_expensive ? 'yes' : 'no'}
marginal_cost_usd=${plan.cost_hint?.marginal_call_cost_usd ?? 0}

reasons:
${reasonText}

warnings:
${warningText}

next_step: ${plan.next_step || '–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∑–∞–¥–∞—á—É.'}`;
                setText('assistantMeta', `Preflight OK ‚Ä¢ –ø—Ä–æ—Ñ–∏–ª—å: ${plan.profile || '-'} ‚Ä¢ –∫–∞–Ω–∞–ª: ${execution.channel || '-'}`);
            } catch (error) {
                document.getElementById('assistantOutput').textContent = `–û—à–∏–±–∫–∞ preflight: ${error.message}`;
                setText('assistantMeta', 'Preflight –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π');
            }
        }

        async function submitModelFeedback() {
            const scoreRaw = (document.getElementById('feedbackScore').value || '').trim();
            const profileRaw = (document.getElementById('feedbackProfile').value || '').trim();
            const noteRaw = (document.getElementById('feedbackNote').value || '').trim();
            const score = Number.parseInt(scoreRaw, 10);

            if (!Number.isInteger(score) || score < 1 || score > 5) {
                setText('feedbackMeta', '–û—à–∏–±–∫–∞: score –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5');
                return;
            }

            setText('feedbackMeta', '–°–æ—Ö—Ä–∞–Ω—è—é feedback...');
            try {
                const payload = { score, note: noteRaw };
                if (profileRaw) {
                    payload.profile = profileRaw.toLowerCase();
                }
                const response = await postJson('/api/model/feedback', payload, true, 'POST');
                if (!response?.ok) {
                    throw new Error(response?.error || 'feedback_submit_failed');
                }

                const result = response.result || {};
                setText(
                    'feedbackMeta',
                    `OK: ${result.model || '-'} (${result.profile || '-'}) ‚Üí ${result.profile_model_stats?.avg ?? 0}/5`
                );
            } catch (error) {
                setText('feedbackMeta', `–û—à–∏–±–∫–∞ feedback: ${error.message}`);
            }
        }

        async function loadModelFeedbackStats() {
            const profileRaw = (document.getElementById('feedbackProfile').value || '').trim();
            const query = profileRaw ? `?profile=${encodeURIComponent(profileRaw.toLowerCase())}&top=5` : '?top=5';
            setText('feedbackMeta', '–ó–∞–≥—Ä—É–∂–∞—é feedback-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...');

            try {
                const payload = await fetchJson(`/api/model/feedback${query}`);
                if (!payload?.ok) {
                    throw new Error(payload?.error || 'feedback_summary_failed');
                }
                const feedback = payload.feedback || {};
                const models = feedback.top_models || [];
                const channels = feedback.top_channels || [];
                const modelsText = models.length
                    ? models.map((item) => `- ${item.model} (${item.profile}): ${item.avg_score}/5, n=${item.count}`).join('\n')
                    : '- –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                const channelsText = channels.length
                    ? channels.map((item) => `- ${item.channel}: ${item.avg_score}/5, n=${item.count}`).join('\n')
                    : '- –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                document.getElementById('assistantOutput').textContent =
`Feedback summary:
profile=${feedback.profile || 'all'}
total_feedback=${feedback.total_feedback || 0}

top models:
${modelsText}

top channels:
${channelsText}`;
                setText('feedbackMeta', `Feedback loaded ‚Ä¢ total=${feedback.total_feedback || 0}`);
            } catch (error) {
                setText('feedbackMeta', `–û—à–∏–±–∫–∞ feedback stats: ${error.message}`);
            }
        }

        async function updateStats() {
            try {
                const [stats, health, links, recommend, feedbackPayload, usagePayload, alertsPayload, historyPayload] = await Promise.all([
                    fetchJson('/api/stats'),
                    fetchJson('/api/health'),
                    fetchJson('/api/links'),
                    fetchJson('/api/model/recommend?profile=chat'),
                    fetchJson('/api/model/feedback?profile=chat&top=1'),
                    fetchJson('/api/ops/usage'),
                    fetchJson('/api/ops/alerts'),
                    fetchJson('/api/ops/history?limit=8')
                ]);

                const bb = stats.black_box || {};
                const rag = stats.rag || {};
                const router = stats.router || {};

                setText('bb_total', String(bb.total ?? bb.total_messages ?? 0));
                setText('rag_total', String(rag.count ?? 0));
                setText('local_model', router.local_model || 'Offline');
                setText('degradation', health.degradation || 'unknown');

                const checks = health.checks || {};
                document.getElementById('checks').innerHTML =
                    badge(!!checks.openclaw, 'OpenClaw') +
                    badge(!!checks.local_lm, 'Local LM') +
                    badge(!!checks.voice_gateway, 'Voice Gateway') +
                    badge(!!checks.krab_ear, 'Krab Ear');

                const linksBlock = [
                    ['Dashboard', links.dashboard],
                    ['Stats API', links.stats_api],
                    ['Health API', links.health_api],
                    ['Ecosystem Health API', links.ecosystem_health_api],
                    ['Model Preflight API', `${links.dashboard}/api/model/preflight`],
                    ['Model Feedback API', `${links.dashboard}/api/model/feedback`],
                    ['OpenClaw Deep Check', `${links.dashboard}/api/openclaw/deep-check`],
                    ['OpenClaw Remediation Plan', `${links.dashboard}/api/openclaw/remediation-plan`],
                    ['OpenClaw Browser Smoke', `${links.dashboard}/api/openclaw/browser-smoke`],
                    ['Assistant Capabilities', `${links.dashboard}/api/assistant/capabilities`],
                    ['Ops Cost Report', `${links.dashboard}/api/ops/cost-report`],
                    ['Ops Executive Summary', `${links.dashboard}/api/ops/executive-summary`],
                    ['Ops Full Report', `${links.dashboard}/api/ops/report`],
                    ['Ops Bundle Export', `${links.dashboard}/api/ops/bundle/export`],
                    ['OpenClaw', links.openclaw],
                    ['Voice Gateway', links.voice_gateway],
                ].filter(([, url]) => !!url)
                 .map(([name, url]) => `<a href="${url}" target="_blank" rel="noreferrer">${name}: ${url}</a>`)
                 .join('');
                document.getElementById('links').innerHTML = linksBlock || '‚Äî';

                setText('recommended_model', recommend.model || '‚Äî');
                const bestFeedback = feedbackPayload?.feedback?.top_models?.[0] || null;
                if (bestFeedback) {
                    setText(
                        'recommended_meta',
                        `–ü—Ä–æ—Ñ–∏–ª—å: ${recommend.profile || 'chat'} ‚Ä¢ –ö–∞–Ω–∞–ª: ${recommend.channel || 'auto'} ‚Ä¢ Quality: ${bestFeedback.avg_score}/5 (n=${bestFeedback.count})`
                    );
                } else {
                    setText('recommended_meta', `–ü—Ä–æ—Ñ–∏–ª—å: ${recommend.profile || 'chat'} ‚Ä¢ –ö–∞–Ω–∞–ª: ${recommend.channel || 'auto'}`);
                }

                const usage = usagePayload.usage || {};
                const totals = usage.totals || {};
                const ratios = usage.ratios || {};
                const softCap = usage.soft_cap || {};
                setText(
                    'opsUsageMeta',
                    `Calls: total=${totals.all_calls ?? 0}, cloud=${totals.cloud_calls ?? 0}, local=${totals.local_calls ?? 0} ‚Ä¢ cloud_share=${ratios.cloud_share ?? 0} ‚Ä¢ cap_left=${softCap.cloud_remaining_calls ?? 0}`
                );

                const alertsRoot = alertsPayload.alerts || {};
                const alertsList = alertsRoot.alerts || [];
                if (!alertsList.length) {
                    document.getElementById('opsAlerts').innerHTML = '<span class="badge ok">OK no active alerts</span>';
                } else {
                    const html = alertsList
                        .map((item) => {
                            const ack = item.acknowledged ? ` <span class="badge ok">ACK ${item.ack?.actor || ''}</span>` : '';
                            return `<div><span class="badge ${item.severity === 'high' ? 'bad' : 'warn'}">${item.severity || 'info'}</span> ${item.code || ''} ‚Äî ${item.message || ''}${ack}</div>`;
                        })
                        .join('');
                    document.getElementById('opsAlerts').innerHTML = html;
                }

                const history = historyPayload.history?.items || [];
                if (!history.length) {
                    setText('opsHistory', '–ò—Å—Ç–æ—Ä–∏—è ops: –ø—É—Å—Ç–æ');
                } else {
                    document.getElementById('opsHistory').innerHTML = history
                        .map((item) => `${item.ts || '-'} ‚Ä¢ ${item.status || '-'} ‚Ä¢ alerts=${item.alerts_count ?? 0} ‚Ä¢ codes=${(item.codes || []).join(',') || '-'}`)
                        .join('<br>');
                }
                setText('updated_at', `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString()}`);
            } catch (error) {
                console.error('Stats update failed', error);
                setText('updated_at', `–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}`);
            }
        }

        document.getElementById('refreshBtn').addEventListener('click', updateStats);
        document.getElementById('assistantRunBtn').addEventListener('click', assistantQuery);
        document.getElementById('assistantPlanBtn').addEventListener('click', assistantPreflight);
        document.getElementById('feedbackSendBtn').addEventListener('click', submitModelFeedback);
        document.getElementById('feedbackStatsBtn').addEventListener('click', loadModelFeedbackStats);
        document.getElementById('opsAckBtn').addEventListener('click', () => opsAckAction(true));
        document.getElementById('opsUnackBtn').addEventListener('click', () => opsAckAction(false));
        setInterval(updateStats, 8000);
        updateStats();
    </script>
</body>

</html>
