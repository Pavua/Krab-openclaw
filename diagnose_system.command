#!/bin/bash
# diagnose_system.command
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≥–ª—É–±–æ–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã Krab/OpenClaw –Ω–∞ macOS.

echo "üîç –ó–∞–ø—É—Å–∫ –≥–ª—É–±–æ–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã..."
cd "$(dirname "$0")"

echo "--- [1. –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ] ---"
df -h . | awk 'NR==1 || /^\//'
echo "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: Avail - —ç—Ç–æ –°–í–û–ë–û–î–ù–û–ï –º–µ—Å—Ç–æ. 106G –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º–µ—Å—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ."

echo -e "\n--- [2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–∞–∑ –î–∞–Ω–Ω—ã—Ö SQLite] ---"
for db in *.db logs/*.db data/*.db; do
    if [ -f "$db" ]; then
        echo -n "–ü—Ä–æ–≤–µ—Ä–∫–∞ $db: "
        sqlite3 "$db" "PRAGMA integrity_check;"
    fi
done

echo -e "\n--- [3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –°–µ—Ç–µ–≤—ã—Ö –ü–æ—Ä—Ç–æ–≤] ---"
echo "OpenClaw (18789):"
lsof -i :18789 || echo "‚ùå –ü–æ—Ä—Ç 18789 –Ω–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç—Å—è (OpenClaw –≤—ã–∫–ª—é—á–µ–Ω?)"
echo "Web Panel (8080):"
lsof -i :8080 || echo "‚ö†Ô∏è –ü–æ—Ä—Ç 8080 –Ω–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç—Å—è."

echo -e "\n--- [4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ AI (LM Studio)] ---"
# –ü—Ä–æ–±—É–µ–º –ø–∏–Ω–≥–∞–Ω—É—Ç—å –ø–æ—Ä—Ç LM Studio (–µ—Å–ª–∏ –∞–¥—Ä–µ—Å –∏–∑–≤–µ—Å—Ç–µ–Ω)
curl -s -o /dev/null --connect-timeout 2 http://192.168.0.171:1234/v1/models && echo "‚úÖ LM Studio (192.168.0.171:1234) –¥–æ—Å—Ç—É–ø–µ–Ω." || echo "‚ùå LM Studio –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å–µ—Ç–∏."

echo -e "\n--- [5. –ê–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö] ---"
if [ -f "logs/errors.log" ]; then
    tail -n 10 logs/errors.log
elif [ -f "krab.log" ]; then
    grep -i "error" krab.log | tail -n 5
fi

echo -e "\n‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞..."
