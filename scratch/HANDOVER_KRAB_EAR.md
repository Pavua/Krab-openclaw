# System Handover: KrabEar & OpenClaw

## 1. Глобальная Цель
Создание **автономной экосистемы** персонального ИИ-ассистента, состоящей из двух независимых, но интегрируемых частей:
1.  **KrabEar (Voice IO)**: Локальный модуль для работы с голосом (STT/TTS), транскрибации встреч и управления компьютером через голосовые команды. Должен быть полностью автономен.
2.  **OpenClaw (Core Intelligence)**: Центральный «мозг» (LLM Gateway, RAG, Agents), который обрабатывает сложные запросы и хранит контекст.

**Текущий статус:** KrabEar доведен до стабильного релиза v4.7 (Premium), OpenClaw находится в активной разработке.

---

## 2. Текущий Контекст (KrabEar v4.7)

### Архитектура
*   **Язык**: Python 3.13 (через `venv`).
*   **GUI**: `tkinter` + `ttk` (нативный вид macOS).
*   **Audio Engine**: `mlx_whisper` (локальная транскрибация на Apple Silicon) + `sounddevice`.
*   **System Integration**: `Applescript` (для вставки текста) + `pystray` (трей) + `Pillow`.

### Ключевые Файлы
*   `KrabEar/main.py`: Точка входа.
*   `KrabEar/ui/window.py`: Основная логика GUI, треды записи, горячие клавиши, настройки, оверлей субтитров (`SubtitleWindow`).
*   `KrabEar/core/engine.py`: Класс `AudioEngine`. Логика Whisper, интеграция с Google Gemini (через OpenClaw Gateway или напрямую), TTS (`say`).
*   `KrabEar/requirements.txt`: Актуальные зависимости.

### Реализованный Функционал
1.  **Recording**: Стабильная запись с `sounddevice`, без крэшей при остановке.
2.  **Transcription**: Локальный Whisper (`mlx-community/whisper-large-v3-turbo`). Русский язык по умолчанию.
3.  **Smart Paste**: Вставка текста через имитацию нажатия `Cmd+V` (код 9) для поддержки русской раскладки. Авто-скрытие окна при вставке.
4.  **Premium Features**:
    *   **Live Translation**: Мгновенный перевод (через Gemini) и вставка.
    *   **Subtitles**: Плавающее окно с субтитрами/переводом.
    *   **TTS**: Озвучка результата системным голосом.
5.  **Persistence**: Настройки сохраняются в `krab_settings.json`.
6.  **Tray Icon**: Работа в фоне, управление из статус-бара.

---

## 3. Принятые Решения (Constraints)

1.  **Локальность**: Транскрибация ВСЕГДА выполняется локально (MLX) для приватности и скорости. Никаких облачных API для STT.
2.  **Автономность**: KrabEar не должен *падать*, если OpenClaw недоступен. Он должен просто писать в лог ошибку подключения к "мозгу", но продолжать работать как диктофон/транскрибатор.
3.  **macOS-first**: Используем специфичные для Mac инструменты (`say`, `osascript`, `AppKit` через врапперы) для лучшего UX. Кроссплатформенность вторична.
4.  **Синхронный UI**: Тяжелые задачи (транскрибация, сеть) всегда в отдельных потоках (`threading`), чтобы GUI не фризился.

---

## 4. Следующий Шаг (Migration & New Chat)

1.  **Backup**: В текущей папке создан архив `project_backup_20260209.zip`.
2.  **Migration**:
    *   Создать новый проект/репозиторий для **KrabEar** (чистый старт).
    *   Перенести туда папку `KrabEar/` и скрипт запуска `Start Krab Ear.command`.
    *   Проверить `requirements.txt` и создать свежее виртуальное окружение.
3.  **Integration**:
    *   В новом OpenClaw настроить API endpoint, к которому KrabEar будет обращаться за "интеллектом" (перевод, ответы).
    *   Убедиться, что форматы JSON-пейлоадов совпадают (сейчас это OpenAI-like формат).

**Команда для следующего агента:**
"Используй `project_backup_20260209.zip` как исходник. Извлеки `KrabEar` в отдельный проект. Проверь его работоспособность в изоляции от старого окружения."
